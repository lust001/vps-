name: Linux VPS Setup with Cloudflare Tunnel

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    services:
      ssh-server:
        image: linuxserver/openssh-server
        env:
          PUID: 1000
          PGID: 1000
          USER_NAME: runneradmin
          USER_PASSWORD: P@ssw0rd!
          TZ: Etc/UTC
          PASSWORD_ACCESS: "true"
          SUDO_ACCESS: "false"
        ports:
          - 2222:2222

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt remove -y containerd containerd.io || true
          sudo apt install -y --fix-broken wget nmap docker.io
          sudo systemctl start docker
          sudo systemctl enable docker

      - name: Show Runner IP
        run: |
          echo "=== Runner External IP ==="
          curl -s https://api.ipify.org || echo "Failed to get external IP"
          echo ""
          echo "=== Runner Internal IP ==="
          ip addr show | grep inet || echo "Failed to get internal IP"

      - name: Debug SSH Server Container
        run: |
          echo "=== Docker Containers ==="
          docker ps -a || echo "Docker ps failed"
          echo "=== SSH Server Logs ==="
          docker logs ssh-server || echo "No logs available"
          echo "=== Container Network ==="
          docker inspect ssh-server | jq -r '.[] | .NetworkSettings.IPAddress' || echo "No IP address found"
          echo "=== Container Ports ==="
          docker inspect ssh-server | jq -r '.[] | .NetworkSettings.Ports' || echo "No port info"

      - name: Get SSH Server IP
        id: get-ip
        run: |
          CONTAINER_IP=$(docker inspect ssh-server | jq -r '.[] | .NetworkSettings.IPAddress')
          if [ -z "$CONTAINER_IP" ]; then
            echo "Failed to get container IP"
            exit 1
          fi
          echo "CONTAINER_IP=$CONTAINER_IP" >> $GITHUB_ENV
          echo "=== SSH Server IP ==="
          echo "$CONTAINER_IP"

      - name: Verify SSH Server
        run: |
          echo "=== Waiting for SSH server ==="
          for i in {1..6}; do
            sleep 10
            ping -c 2 ${{ env.CONTAINER_IP }} && break || echo "Ping attempt $i failed"
          done
          echo "=== Nmap Scan ==="
          nmap ${{ env.CONTAINER_IP }} -p 2222 || echo "Nmap failed"
          echo "=== SSH Test ==="
          for i in {1..3}; do
            ssh -v -p 2222 -o StrictHostKeyChecking=no runneradmin@${{ env.CONTAINER_IP }} whoami && break || echo "SSH attempt $i failed"
            sleep 5
          done

      - name: Install Cloudflared CLI
        run: |
          sudo mkdir -p --mode=0755 /usr/share/keyrings
          curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null
          echo 'deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared focal main' | sudo tee /etc/apt/sources.list.d/cloudflared.list
          sudo apt update
          sudo apt install -y cloudflared
          cloudflared --version

      - name: Launch Cloudflare Quick Tunnel & Keep Alive
        run: |
          cloudflared tunnel --url ssh://${{ env.CONTAINER_IP }}:2222 > tunnel.log 2>&1 &
          sleep 20
          echo "=== Tunnel Endpoint ==="
          grep -Eo 'https://[a-z0-9-]+\.trycloudflare\.com' tunnel.log || cat tunnel.log
          ps aux | grep '[c]loudflared' || echo "No cloudflared process found"
          for i in {1..360}; do
            ps aux | grep '[c]loudflared' || echo "cloudflared process stopped"
            sleep 60
          done
